name: Deploy to k3s (self-hosted)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-k3s-prod
  cancel-in-progress: false

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: [self-hosted, linux, cortex-k3s]
    environment: production

    env:
      NAMESPACE: cortex
      OVERLAY_DIR: deploy/k8s/overlays/prod
      IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/cortex
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Set up kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Write kubeconfig from secret (optional)
        if: ${{ secrets.K3S_KUBECONFIG != '' }}
        env:
          K3S_KUBECONFIG: ${{ secrets.K3S_KUBECONFIG }}
        run: |
          set -euo pipefail
          umask 077
          printf '%s\n' "$K3S_KUBECONFIG" > "$RUNNER_TEMP/kubeconfig"
          echo "KUBECONFIG=$RUNNER_TEMP/kubeconfig" >> "$GITHUB_ENV"

      - name: Verify cluster access
        run: |
          set -euo pipefail
          kubectl version --client=true
          kubectl get namespace "$NAMESPACE"

      - name: Deploy overlay and run smoke checks
        run: |
          set -euo pipefail
          chmod +x scripts/deploy-k3s.sh
          ./scripts/deploy-k3s.sh
